<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Map â€“ The Narrative</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="assets/css/site.css">
  <link rel="stylesheet" href="assets/css/index.css">
  <link rel="stylesheet" href="assets/css/calendar.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" crossorigin="">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" crossorigin="">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/4.0.0/Control.FullScreen.min.css" crossorigin="">
  <style>
    #map { min-height: 70vh; width: 100%; }
    .leaflet-popup-content-wrapper { min-width: 400px; max-width: 520px; }
    .leaflet-popup-content { margin: 12px 16px; width: auto !important; }
    .map-popup-content-row { display: flex; gap: 12px; align-items: flex-start; margin-top: 6px; }
    .map-popup-body { flex: 1; min-width: 0; }
    .map-popup .entry-preview { margin-top: 0; }
    .map-popup .entry-thumb { flex-shrink: 0; width: 56px; height: 56px; object-fit: cover; border-radius: 4px; }
    .leaflet-control-fit-all {
      background: #fff;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      z-index: 1000;
    }
    .leaflet-control-fit-all a {
      display: block;
      width: 36px;
      height: 36px;
      line-height: 36px;
      text-align: center;
      text-decoration: none;
      color: #333;
      font-size: 12px;
      font-weight: bold;
      border-radius: 4px;
    }
    .leaflet-control-fit-all a:hover { background: #f4f4f4; }
  </style>
</head>
<body data-photo-index-url="entries/photo-index.json" data-archive-root="./">

  <header class="hero-header">
    <h1>The Narrative</h1>
    <p class="subtitle">Map</p>
  </header>

  <div class="main-wrap">
    <div class="compact-header-wrap">
      <header class="compact-header">
        <h1><a href="index.html">The Narrative</a></h1>
      </header>
    </div>

    <div class="content-sheet">
      <nav class="tabs" aria-label="View">
        <a href="index.html" class="tab">List</a>
        <a href="calendar.html" class="tab">Calendar</a>
        <a href="media.html" class="tab">Media</a>
        <a href="map.html" class="tab is-active">Map</a>
        <a href="search.html" class="tab">Search</a>
      </nav>

      <main>
        <div id="map"></div>
      </main>
    </div>
  </div>

  <script src="assets/js/nav.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/4.0.0/Control.FullScreen.min.js" crossorigin=""></script>
  <script>
    (function () {
      var hero = document.querySelector('.hero-header');
      if (hero) {
        var observer = new IntersectionObserver(function (entries) {
          document.body.classList.toggle('hero-out', !entries[0].isIntersecting);
        }, { rootMargin: '0px', threshold: 0.20 });
        observer.observe(hero);
      }
    })();
  </script>
  <script>
    (function () {
      function escapeHtml(s) {
        if (!s) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      fetch('entries/location-index.json')
        .then(function (r) { return r.json(); })
        .catch(function () { return { locations: [] }; })
        .then(function (data) {
          var list = data.locations || [];
          var center = [20, 0];
          var zoom = 2;
          if (list.length) {
            center = [list[0].lat, list[0].lng];
            zoom = 14;
          }

          var map = L.map('map').setView(center, zoom);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
          }).addTo(map);

          if (typeof L.control.fullscreen === 'function') {
            L.control.fullscreen({ title: 'Full Screen', titleCancel: 'Exit Full Screen' }).addTo(map);
          }

          var markers = L.markerClusterGroup();
          map.addLayer(markers);

          var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
          list.forEach(function (loc) {
            var popup = '<div class="map-popup">';
            var dateLabel = '';
            if (loc.date) {
              var parts = loc.date.split('-');
              if (parts.length >= 3) {
                var mon = months[parseInt(parts[1], 10) - 1] || '';
                var d = parseInt(parts[2], 10);
                var yr = parts[0];
                dateLabel = (loc.dow ? loc.dow + ' ' : '') + d + ' ' + mon + ' ' + yr;
              } else {
                dateLabel = loc.date;
              }
            }
            if (dateLabel) popup += '<p><strong>' + escapeHtml(dateLabel) + '</strong></p>';
            popup += '<div class="map-popup-content-row">';
            popup += '<div class="map-popup-body">';
            if (loc.snippet) popup += '<p class="entry-preview">' + escapeHtml(loc.snippet) + '</p>';
            if (loc.meta_line) popup += '<div class="entry-meta">' + escapeHtml(loc.meta_line) + '</div>';
            popup += '<p><a href="' + escapeHtml(loc.path) + '">View entry</a></p>';
            popup += '</div>';
            if (loc.thumbnail_url) {
              popup += '<img class="entry-thumb" src="' + escapeHtml(loc.thumbnail_url) + '" alt="" width="56" height="56">';
            }
            popup += '</div></div>';
            var m = L.marker([loc.lat, loc.lng]).bindPopup(popup);
            markers.addLayer(m);
          });

          var FitAllControl = L.Control.extend({
            onAdd: function () {
              var container = document.createElement('div');
              container.className = 'leaflet-control-fit-all leaflet-bar';
              var btn = document.createElement('a');
              btn.href = '#';
              btn.title = 'Show all entries';
              btn.setAttribute('role', 'button');
              btn.textContent = 'All';
              btn.onclick = function (e) {
                e.preventDefault();
                var bounds = markers.getBounds();
                if (bounds && bounds.isValid()) {
                  map.fitBounds(bounds, { padding: [24, 24], maxZoom: 15 });
                }
              };
              container.appendChild(btn);
              return container;
            }
          });
          map.addControl(new FitAllControl({ position: 'topright' }));
        });
    })();
  </script>
</body>
</html>
