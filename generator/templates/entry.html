<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ css_path }}sakura.css">
  <link rel="stylesheet" href="{{ css_path }}site.css">
  <style>
    .entry-nav-popup-wrapper { display: none; position: relative; }
    .js-enabled .entry-nav-inline { display: none; }
    .js-enabled .entry-nav-popup-wrapper { display: inline-block; }
    .entry-nav-trigger {
      background: transparent;
      border: 1px solid currentColor;
      border-radius: 4px;
      color: inherit;
      cursor: pointer;
      font: inherit;
      padding: 0.25em 0.6em;
    }
    .entry-nav .entry-nav-trigger:hover { color: #0288d1; background: rgba(2, 136, 209, 0.15); }
    .entry-nav-menu {
      position: absolute;
      bottom: 100%;
      right: 0;
      margin-bottom: 0.25em;
      min-width: 8em;
      padding: 0.5em 0;
      background: #fff;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10;
    }
    .entry-nav-menu[hidden] { display: none; }
    .entry-nav-menu a {
      display: block;
      padding: 0.4em 1em;
      color: inherit;
      text-decoration: none;
    }
    .entry-nav-menu a:hover { background: rgba(0,0,0,0.06); }
  </style>
</head>
<body data-photo-index-url="{{ photo_index_url | default('') }}" data-archive-root="../../../">
  <main>
    <article class="entry" aria-labelledby="entry-title">

      <h1 id="entry-title">
        <time datetime="{{ creation_date_iso }}">
          {{ creation_date_formatted }}{% if creation_time_formatted %} <span class="entry-time">{{ creation_time_formatted }}</span>{% endif %}
        </time>
      </h1>

      {% if location %}
      <p class="entry-meta">
          <span class="location h-geo">
            {% if place_name %}<span class="p-name">{{ place_name }}</span>{% if locality_name or country %}, {% endif %}{% endif %}
            {% if locality_name %}<span class="p-locality">{{ locality_name }}</span>{% if country %}, {% endif %}{% endif %}
            {% if country %}<span class="p-country-name">{{ country }}</span>{% endif %}
            {% if latitude and longitude %}
            <data class="p-latitude" value="{{ latitude }}"></data>
            <data class="p-longitude" value="{{ longitude }}"></data>
            {% endif %}
          </span>
        </p>
      {% endif %}

      <section class="entry-body">
        {{ body_html | safe }}
      </section>

      {% if weather or moon_phase %}
      <footer class="entry-footer">
        <p class="entry-context">
          {% if weather %}<span class="weather">{% if weather_emoji %}{{ weather_emoji }} {% endif %}{{ weather }}</span>{% endif %}
          {% if weather and moon_phase %}<span class="context-sep">·</span>{% endif %}
          {% if moon_phase %}<span class="moon">{% if moon_emoji %}{{ moon_emoji }} {% endif %}{{ moon_phase }}</span>{% endif %}
        </p>
      </footer>
      {% endif %}

    </article>

    <nav class="entry-nav" aria-label="Entry navigation">
      <span class="entry-nav-prev-next">
        {% if prev_url %}<a href="{{ prev_url }}" rel="prev">Previous</a>{% endif %}
        {% if prev_url and next_url %} · {% endif %}
        {% if next_url %}<a href="{{ next_url }}" rel="next">Next</a>{% endif %}
      </span>
      <span class="entry-nav-links">
        <span class="entry-nav-inline">
          {% if otd_url %}<a href="{{ otd_url }}" class="entry-nav-otd">On this day</a> · {% endif %}
          <a href="{{ tab_urls.index_url }}" class="entry-nav-index">List</a> ·
          <a href="{{ tab_urls.calendar_url }}" class="entry-nav-calendar">Calendar</a> ·
          <a href="{{ tab_urls.media_url }}" class="entry-nav-media">Media</a> ·
          <a href="{{ tab_urls.map_url }}" class="entry-nav-map">Map</a> ·
          <a href="{{ tab_urls.search_url }}" class="entry-nav-search">Search</a>
        </span>
        <span class="entry-nav-popup-wrapper" aria-hidden="true">
          <button type="button" class="entry-nav-trigger" aria-haspopup="true" aria-expanded="false" aria-controls="entry-nav-menu">Menu</button>
          <div id="entry-nav-menu" class="entry-nav-menu" role="menu" hidden>
            {% if otd_url %}<a href="{{ otd_url }}" role="menuitem">On this day</a>{% endif %}
            <a href="{{ tab_urls.index_url }}" role="menuitem">List</a>
            <a href="{{ tab_urls.calendar_url }}" role="menuitem">Calendar</a>
            <a href="{{ tab_urls.media_url }}" role="menuitem">Media</a>
            <a href="{{ tab_urls.map_url }}" role="menuitem">Map</a>
            <a href="{{ tab_urls.search_url }}" role="menuitem">Search</a>
          </div>
        </span>
      </span>
    </nav>
  </main>
  <script src="{{ js_path }}nav.js"></script>
  <script>
    (function() {
      document.body.classList.add('js-enabled');
      var trigger = document.querySelector('.entry-nav-trigger');
      var menu = document.getElementById('entry-nav-menu');
      var wrapper = document.querySelector('.entry-nav-popup-wrapper');
      if (!trigger || !menu || !wrapper) return;

      function open() {
        menu.hidden = false;
        trigger.setAttribute('aria-expanded', 'true');
        wrapper.removeAttribute('aria-hidden');
        document.addEventListener('click', closeOnOutside);
        document.addEventListener('keydown', closeOnEscape);
      }
      function close() {
        menu.hidden = true;
        trigger.setAttribute('aria-expanded', 'false');
        wrapper.setAttribute('aria-hidden', 'true');
        document.removeEventListener('click', closeOnOutside);
        document.removeEventListener('keydown', closeOnEscape);
      }
      function closeOnOutside(e) {
        if (!wrapper.contains(e.target)) close();
      }
      function closeOnEscape(e) {
        if (e.key === 'Escape') close();
      }

      function isElementInViewport(el) {
        if (!el || !el.getBoundingClientRect) return false;
        var rect = el.getBoundingClientRect();
        var viewHeight = window.innerHeight || document.documentElement.clientHeight || 0;
        var viewWidth = window.innerWidth || document.documentElement.clientWidth || 0;
        return (
          rect.bottom > 0 &&
          rect.right > 0 &&
          rect.top < viewHeight &&
          rect.left < viewWidth
        );
      }

      function getMenuItems() {
        return Array.prototype.slice.call(menu.querySelectorAll('a[role="menuitem"]'));
      }

      function getFocusedMenuIndex(items) {
        var active = document.activeElement;
        for (var i = 0; i < items.length; i++) {
          if (items[i] === active) return i;
        }
        return -1;
      }

      function focusFirstMenuItem() {
        var items = getMenuItems();
        if (!items.length) return;
        items[0].focus();
      }

      function isLightboxOpen() {
        var lb = document.querySelector('.photo-lightbox.is-open');
        return !!lb;
      }

      trigger.addEventListener('click', function(e) {
        e.stopPropagation();
        if (menu.hidden) open(); else close();
      });

      document.addEventListener('keydown', function(e) {
        if (isLightboxOpen()) return;
        if (e.altKey || e.ctrlKey || e.metaKey) return;

        var key = e.key;

        // Left/Right arrows: previous/next entry navigation.
        if (key === 'ArrowLeft') {
          var prevLink = document.querySelector('.entry-nav-prev-next a[rel="prev"]');
          if (!prevLink) return;
          e.preventDefault();
          window.location.href = prevLink.href;
          return;
        }
        if (key === 'ArrowRight') {
          var nextLink = document.querySelector('.entry-nav-prev-next a[rel="next"]');
          if (!nextLink) return;
          e.preventDefault();
          window.location.href = nextLink.href;
          return;
        }

        // Space: toggle menu only when trigger is in view.
        if (key === ' ' || key === 'Spacebar') {
          if (!isElementInViewport(trigger)) return;
          e.preventDefault();
          if (menu.hidden) {
            open();
            focusFirstMenuItem();
          } else {
            close();
            trigger.focus();
          }
          return;
        }

        // Up/Down arrows: move between menu items only when menu is visible.
        if (key === 'ArrowDown' || key === 'ArrowUp') {
          if (menu.hidden) return;
          var items = getMenuItems();
          if (!items.length) return;
          e.preventDefault();
          var idx = getFocusedMenuIndex(items);
          if (idx === -1) {
            idx = key === 'ArrowDown' ? 0 : items.length - 1;
          } else if (key === 'ArrowDown') {
            idx = (idx + 1) % items.length;
          } else if (key === 'ArrowUp') {
            idx = (idx - 1 + items.length) % items.length;
          }
          items[idx].focus();
        }
      });
    })();
  </script>
</body>
</html>
